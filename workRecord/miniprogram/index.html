<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>uni/小程序相关 | 一些零碎</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.84741abc.css" as="style"><link rel="preload" href="/assets/js/app.9047f944.js" as="script"><link rel="preload" href="/assets/js/2.3410de3c.js" as="script"><link rel="preload" href="/assets/js/25.3dc1aead.js" as="script"><link rel="prefetch" href="/assets/js/10.bdbae3fc.js"><link rel="prefetch" href="/assets/js/11.bd439ed2.js"><link rel="prefetch" href="/assets/js/12.c83ea86a.js"><link rel="prefetch" href="/assets/js/13.f4613efb.js"><link rel="prefetch" href="/assets/js/14.b0c39b9a.js"><link rel="prefetch" href="/assets/js/15.45cb6731.js"><link rel="prefetch" href="/assets/js/16.bfcd93e3.js"><link rel="prefetch" href="/assets/js/17.b66fdd0f.js"><link rel="prefetch" href="/assets/js/18.69202b33.js"><link rel="prefetch" href="/assets/js/19.4a56e1ce.js"><link rel="prefetch" href="/assets/js/20.ec6893db.js"><link rel="prefetch" href="/assets/js/21.afc02202.js"><link rel="prefetch" href="/assets/js/22.36a902ec.js"><link rel="prefetch" href="/assets/js/23.bf30863b.js"><link rel="prefetch" href="/assets/js/24.16c949c5.js"><link rel="prefetch" href="/assets/js/26.8cc16656.js"><link rel="prefetch" href="/assets/js/3.5542bbb8.js"><link rel="prefetch" href="/assets/js/4.8338fec5.js"><link rel="prefetch" href="/assets/js/5.ff064d77.js"><link rel="prefetch" href="/assets/js/6.15a0983c.js"><link rel="prefetch" href="/assets/js/7.c91364c1.js"><link rel="prefetch" href="/assets/js/8.af33230f.js"><link rel="prefetch" href="/assets/js/9.11aabaf0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84741abc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一些零碎</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript相关知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript/promise/" class="sidebar-link">Promise</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue相关知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/complie/" class="sidebar-link">模板解析</a></li><li><a href="/vue/genRender/" class="sidebar-link">生成render函数</a></li><li><a href="/vue/render/" class="sidebar-link">挂载渲染阶段</a></li><li><a href="/vue/update/" class="sidebar-link">更新阶段</a></li><li><a href="/vue/component/" class="sidebar-link">组件分析</a></li><li><a href="/vue/lifeCycle/" class="sidebar-link">生命周期</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack相关知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/webpack/entry/" class="sidebar-link">入口</a></li><li><a href="/webpack/optimization/" class="sidebar-link">优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络相关知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/net/http&amp;https/" class="sidebar-link">HTTP&amp;HTTPS</a></li><li><a href="/net/https/" class="sidebar-link">HTTPS</a></li><li><a href="/net/udp&amp;tcp/" class="sidebar-link">UDP&amp;TCP</a></li><li><a href="/net/tcp&amp;&amp;ip/" class="sidebar-link">TCP/IP</a></li><li><a href="/net/dns/" class="sidebar-link">DNS</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/performance/virtualScroll/" class="sidebar-link">虚拟滚动</a></li><li><a href="/performance/cacheApi/" class="sidebar-link">接口缓存</a></li><li><a href="/performance/debounce&amp;throttle/" class="sidebar-link">防抖与节流</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>问题记录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/workRecord/vue/" class="sidebar-link">vue相关</a></li><li><a href="/workRecord/miniprogram/" aria-current="page" class="active sidebar-link">小程序相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_1-canvas-drawimage-oss-上的图片" class="sidebar-link">1. canvas drawImage OSS 上的图片</a></li><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_2-canvas-固定点位适配所有机型" class="sidebar-link">2. canvas 固定点位适配所有机型</a></li><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_3-画点" class="sidebar-link">3. 画点</a></li><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_4-login" class="sidebar-link">4. login</a></li><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_5-支付" class="sidebar-link">5. 支付</a></li><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_6-文件上传到oss-不需要后端情况" class="sidebar-link">6. 文件上传到OSS 不需要后端情况</a></li><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_7-利用后端返回的数据绘制多边形" class="sidebar-link">7. 利用后端返回的数据绘制多边形</a></li><li class="sidebar-sub-header"><a href="/workRecord/miniprogram/#_8-后台配置用百度地图获取目的地经纬度-uni-定位到这个位置不准" class="sidebar-link">8. 后台配置用百度地图获取目的地经纬度 uni 定位到这个位置不准</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-canvas-drawimage-oss-上的图片"><a href="#_1-canvas-drawimage-oss-上的图片" class="header-anchor">#</a> 1. canvas drawImage OSS 上的图片</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>uni<span class="token punctuation">.</span><span class="token function">getImageInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">'https://oss.example.com/wechat/map_bg.png'</span><span class="token punctuation">,</span>
  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_2-canvas-固定点位适配所有机型"><a href="#_2-canvas-固定点位适配所有机型" class="header-anchor">#</a> 2. canvas 固定点位适配所有机型</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">scalePosition</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> isX <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每个机型上容器的宽度</span>
    <span class="token keyword">let</span> contentWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapContentWidth
    <span class="token comment">// 每个机型上容器的高度</span>
    <span class="token keyword">let</span> contentHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapContentHeight
    <span class="token comment">// 标准宽 以什么机型为参照</span>
    <span class="token keyword">let</span> standarX
    <span class="token comment">// 标准高 以什么机型为参照</span>
    <span class="token keyword">let</span> standarY
    <span class="token comment">// 是否横屏</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isLandScape<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        standarX <span class="token operator">=</span> <span class="token number">523.2</span>
        standarY <span class="token operator">=</span> <span class="token number">327</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        standarX <span class="token operator">=</span> <span class="token number">375</span>
        standarY <span class="token operator">=</span> <span class="token number">600</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> scaleX
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scaleX <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">/</span> standarX<span class="token punctuation">)</span> <span class="token operator">*</span> contentWidth
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        scaleX <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">/</span> standarY<span class="token punctuation">)</span> <span class="token operator">*</span> contentHeight
    <span class="token punctuation">}</span>

    <span class="token comment">// 得到每个固定点位在不同机型的位置</span>
    <span class="token keyword">return</span> scaleX
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_3-画点"><a href="#_3-画点" class="header-anchor">#</a> 3. 画点</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 最后没用 ctx.scale(1, -1) 沿 X 轴翻转 然后平移到容器底部 这样做的话导致图标都翻转了
 * 最后采用的是
 * 园区的宽度 / canvas容器的宽度 = 后台返回真是的米 / x
 * 当旋转的时候 将 X轴 Y轴互换
 * 
 * if (this.isLandScape) {
        let systemInfo = uni.getSystemInfoSync()
        console.log('systemInfosystemInfosystemInfo', systemInfo)
        let windowHeight = systemInfo.windowHeight - this.customBarHeight - 40
        result.forEach(res =&gt; {
            res.x = (res.y * windowHeight) / 41.6
            res.y = (res.x * windowHeight) / 41.6
        })
    } else {
        result.forEach(res =&gt; {
            res.x = (res.x * this.screenWidthSystem) / 41.6
            res.y = (res.y * this.screenWidthSystem) / 41.6
        })
    }
 */</span>
<span class="token function">draw</span><span class="token punctuation">(</span><span class="token parameter">points</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> uni<span class="token punctuation">.</span><span class="token function">createCanvasContext</span><span class="token punctuation">(</span><span class="token string">'myCanvas'</span><span class="token punctuation">)</span>

  
  <span class="token comment">// ctx.scale(self.devicePixelRatio, self.devicePixelRatio)</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> uni<span class="token punctuation">.</span><span class="token function">createSelectorQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> phoneInfo <span class="token operator">=</span> uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'phone_info'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  query<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token string">'.map-container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boundingClientRect</span><span class="token punctuation">(</span><span class="token parameter">rect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// 绘制图标</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isLandScape<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">placeOfPic</span><span class="token punctuation">(</span>picDataLandScape<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">placeOfPic</span><span class="token punctuation">(</span>picData<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// if (this.isLandScape) {</span>
    <span class="token comment">//     ctx.scale(1, -1)</span>
    <span class="token comment">//     ctx.translate(0, -this.mapContentHeight)  </span>
    <span class="token comment">// }</span>
    <span class="token comment">// 绘制点位</span>
    points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">point</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> isSelf <span class="token operator">=</span> phoneInfo<span class="token punctuation">.</span>phoneNumber <span class="token operator">===</span> point<span class="token punctuation">.</span>memberPhone

        <span class="token comment">// 内圈</span>
        ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>  
        ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token string">'#ED6066'</span> <span class="token operator">:</span> <span class="token string">'#F08656'</span>
        ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 外圈</span>
        ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'#FFFFFF'</span>
        ctx<span class="token punctuation">.</span>lineWidth <span class="token operator">=</span> <span class="token number">3</span>
        ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        

        <span class="token comment">// 点位图标</span>

        ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">let</span> pointImg <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token string">'./../static/assets/position/map_me.png'</span> <span class="token operator">:</span> <span class="token string">'./../static/assets/position/map_other.png'</span>
        <span class="token keyword">let</span> pointSize <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">44</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span>
        <span class="token keyword">let</span> pointX <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token number">28.5</span> <span class="token operator">:</span> <span class="token number">21.5</span>
        <span class="token keyword">let</span> pointY <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token number">64</span> <span class="token operator">:</span> <span class="token number">50</span>

        <span class="token keyword">let</span> maxDisY <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token number">56</span> <span class="token operator">:</span> <span class="token number">42</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> maxDisY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> pointX<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">+</span> pointY<span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token number">180</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>pointImg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">...</span>pointSize<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
                pointImg<span class="token punctuation">,</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> pointX<span class="token punctuation">,</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">-</span> pointY<span class="token punctuation">,</span>
                <span class="token operator">...</span>pointSize
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 人物标识</span>
        ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> avatarSize <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">]</span>
        <span class="token keyword">let</span> avatarX <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token number">16.5</span> <span class="token operator">:</span> <span class="token number">11.5</span>
        <span class="token keyword">let</span> avatarY <span class="token operator">=</span> isSelf <span class="token operator">?</span> <span class="token number">55</span> <span class="token operator">:</span> <span class="token number">43</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> maxDisY<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token function">getAvatar</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>customerType<span class="token punctuation">,</span> point<span class="token punctuation">.</span>customerSex<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> avatarX <span class="token operator">-</span> <span class="token number">1.2</span><span class="token punctuation">,</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">+</span> avatarY <span class="token operator">/</span> <span class="token number">2.6</span><span class="token punctuation">,</span>
                <span class="token operator">...</span>avatarSize
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
                <span class="token function">getAvatar</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>customerType<span class="token punctuation">,</span> point<span class="token punctuation">.</span>customerSex<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> avatarX<span class="token punctuation">,</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scalePosition</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">-</span> avatarY<span class="token punctuation">,</span> 
                <span class="token operator">...</span>avatarSize
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div><h2 id="_4-login"><a href="#_4-login" class="header-anchor">#</a> 4. login</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 1. 获取code
 */</span>
uni<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">provider</span><span class="token operator">:</span> <span class="token string">'weixin'</span><span class="token punctuation">,</span>
  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> res<span class="token punctuation">.</span>code
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * 2. 用这个 code 调用服务器 接口 获取 openId 存入本地缓存
 */</span>

<span class="token comment">/**
 * 3. 然后使用手机号登录
 */</span>
<span class="token operator">&lt;</span>button  open<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">&quot;getPhoneNumber&quot;</span> @getphonenumber<span class="token operator">=</span><span class="token string">&quot;getPhoneNumber($event)&quot;</span> loadingText<span class="token operator">=</span><span class="token string">&quot;登录中...&quot;</span><span class="token operator">&gt;</span>
  使用微信手机号登录
<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

<span class="token comment">/**
 * 4. 然后通过 e.detail.errmsg 看用户是否允许授权
 * 5. 然后利用这里的 e.detail.code 调取服务器接口 获取手机号
 * 6. 然后将这个 code 和 手机号 以及经纬度 进入最后一步登录 调用服务端接口 获取token
 * 7. 存储 token 跳转页面
 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="_5-支付"><a href="#_5-支付" class="header-anchor">#</a> 5. 支付</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 1. 拿到前端需要传递的参数调用服务端接口
 * 2. 后台返回支付需要的签名、时间戳等参数
 * 3. 拿到这些参数调用uni.requestPayment API (代码如下)
 * 4. 因为微信返回的支付成功不够准确 所以我们还要拿 这个订单号 轮询去查后台的接口 看是否成功
 * 5. 我们是一分钟查五次 如果还没成功 我们就拿这个 订单号 去查服务器另一个接口 如果成功了 就是成功了 失败了就是失败了
 */</span>
<span class="token keyword">const</span> <span class="token constant">QUERY_COUNT</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token constant">TIME</span> <span class="token operator">=</span> <span class="token number">2000</span>
<span class="token keyword">const</span> <span class="token constant">QUERY_MAX</span> <span class="token operator">=</span> <span class="token number">5</span>
uni<span class="token punctuation">.</span><span class="token function">requestPayment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">provider</span><span class="token operator">:</span> <span class="token string">'wxpay'</span><span class="token punctuation">,</span><span class="token comment">//支付类型-固定值</span>
    <span class="token literal-property property">timeStamp</span><span class="token operator">:</span> data<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span><span class="token comment">// 时间戳（单位：秒）</span>
    <span class="token literal-property property">nonceStr</span><span class="token operator">:</span> data<span class="token punctuation">.</span>nonceStr<span class="token punctuation">,</span><span class="token comment">// 随机字符串</span>
    <span class="token keyword">package</span><span class="token operator">:</span> data<span class="token punctuation">.</span>packageValue<span class="token punctuation">,</span><span class="token comment">// 固定值</span>
    <span class="token literal-property property">signType</span><span class="token operator">:</span> data<span class="token punctuation">.</span>signType<span class="token punctuation">,</span><span class="token comment">//固定值</span>
    <span class="token literal-property property">paySign</span><span class="token operator">:</span> data<span class="token punctuation">.</span>paySign<span class="token punctuation">,</span><span class="token comment">//签名</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success:'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token constant">QUERY_COUNT</span> <span class="token operator">=</span> <span class="token number">0</span>
        uni<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">searchOrderStatus</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>orderNo<span class="token punctuation">,</span> options<span class="token punctuation">.</span>isNopayOrder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">orderNo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span>
            uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>errMsg <span class="token operator">==</span> <span class="token string">'requestPayment:fail cancel'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'您已取消支付'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
                <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/ticketPages/myTicketList?orderStatus=0</span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">searchOrderStatus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">orderNo<span class="token punctuation">,</span> isNopayOrder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fromPage <span class="token operator">=</span> isNopayOrder <span class="token operator">?</span> <span class="token string">'noPayOrder'</span> <span class="token operator">:</span> <span class="token string">'buyTickets'</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        DtpApi<span class="token punctuation">.</span><span class="token function">queryOrderStatusIsPayed</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>data
            <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/paymentPages/success?orderNo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orderNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;fromPage=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fromPage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">QUERY_COUNT</span> <span class="token operator">&lt;</span> <span class="token constant">QUERY_MAX</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token operator">++</span><span class="token constant">QUERY_COUNT</span>
                        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token function">searchOrderStatus</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">TIME</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 1分钟过后直接查询微信小程序的订单接口</span>
                        DtpApi<span class="token punctuation">.</span><span class="token function">queryOrderByWm</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">let</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>data
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>tradeState <span class="token operator">===</span> <span class="token string">'SUCCESS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/paymentPages/success?orderNo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orderNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;fromPage=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fromPage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                                    <span class="token function">resolve</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/paymentPages/failed'</span>
                                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                                    uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/paymentPages/failed'</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                                uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                uni<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'/paymentPages/failed'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><h2 id="_6-文件上传到oss-不需要后端情况"><a href="#_6-文件上传到oss-不需要后端情况" class="header-anchor">#</a> 6. 文件上传到OSS 不需要后端情况</h2> <h2 id="_7-利用后端返回的数据绘制多边形"><a href="#_7-利用后端返回的数据绘制多边形" class="header-anchor">#</a> 7. 利用后端返回的数据绘制多边形</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 示例代码数据格式 实际的米数
 * [
 *  {
 *      polygonData: &quot;72.10,17.30|72.10,12.80|76.30,12.80|76.20,17.30|72.10,17.30&quot;
 *  },
 * {
 *      polygonData: &quot;76.40,22.20|76.40,18.80|81.80,18.80|81.80,22.20|76.40,22.20&quot;
 * }
 * ]
 */</span>
<span class="token function">draw</span><span class="token punctuation">(</span><span class="token parameter">polygons</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> ctx <span class="token operator">=</span> uni<span class="token punctuation">.</span><span class="token function">createCanvasContext</span><span class="token punctuation">(</span><span class="token string">'map'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> minx<span class="token punctuation">,</span> miny
    <span class="token keyword">let</span> maxx<span class="token punctuation">,</span> maxy

    <span class="token keyword">let</span> cx<span class="token punctuation">,</span>cy

    polygons<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">polygon</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> points <span class="token operator">=</span> polygon<span class="token punctuation">.</span>polygonData<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">point</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y<span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">targetPoinit</span><span class="token punctuation">(</span><span class="token punctuation">[</span>points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">point</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">targetPoinit</span><span class="token punctuation">(</span><span class="token punctuation">[</span>point<span class="token punctuation">.</span>y<span class="token punctuation">,</span> point<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> targetX <span class="token operator">=</span> points<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
        <span class="token keyword">const</span> targetY <span class="token operator">=</span> points<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

        <span class="token comment">// 获取一个多边形最小的y点位和最大的y点位</span>
        minx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> targetX<span class="token punctuation">)</span>
        maxx <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> targetX<span class="token punctuation">)</span>

        <span class="token comment">// 获取一个多边形最小的x点位和最大的x点位</span>
        miny <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> targetY<span class="token punctuation">)</span>
        maxy <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> targetY<span class="token punctuation">)</span>
        
        <span class="token comment">// 取个中间值将字体放在中间</span>
        cx <span class="token operator">=</span> <span class="token punctuation">(</span>minx <span class="token operator">+</span> maxx<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        cy <span class="token operator">=</span> <span class="token punctuation">(</span>miny <span class="token operator">+</span> maxy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        

        ctx<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>polygon<span class="token punctuation">.</span>areaName <span class="token operator">===</span> <span class="token string">'xx'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#FFFAFA'</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>polygon<span class="token punctuation">.</span>areaName <span class="token operator">===</span> <span class="token string">'yy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#DFECFF'</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>polygon<span class="token punctuation">.</span>areaName <span class="token operator">===</span> <span class="token string">'zz'</span> <span class="token operator">||</span> polygon<span class="token punctuation">.</span>areaName <span class="token operator">===</span> <span class="token string">'vv'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#E8F3E4'</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#FDEBEB'</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


        <span class="token comment">// 保存状态</span>
        ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

        <span class="token comment">// 设置文字样式</span>
        ctx<span class="token punctuation">.</span><span class="token function">setFontSize</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">setFillStyle</span><span class="token punctuation">(</span><span class="token string">'#6D5F5F'</span><span class="token punctuation">)</span>

        ctx<span class="token punctuation">.</span><span class="token function">setTextAlign</span><span class="token punctuation">(</span><span class="token string">'center'</span><span class="token punctuation">)</span>

        <span class="token comment">// 绘制文字</span>
        ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>polygon<span class="token punctuation">.</span>areaName<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">targetPoinit</span><span class="token punctuation">(</span><span class="token punctuation">[</span>cy<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cx<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 恢复剪切区域 </span>
        ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">/**
 * 41.6 实际的米数 370屏幕的宽度
 * 100 实际的米数 700屏幕的高度
 */</span>
<span class="token function">targetPoinit</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">370</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">41.6</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>y <span class="token operator">*</span> <span class="token number">700</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h2 id="_8-后台配置用百度地图获取目的地经纬度-uni-定位到这个位置不准"><a href="#_8-后台配置用百度地图获取目的地经纬度-uni-定位到这个位置不准" class="header-anchor">#</a> 8. 后台配置用百度地图获取目的地经纬度 uni 定位到这个位置不准</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 目的地经纬度
 */</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>
    latitude<span class="token punctuation">,</span>
    longitude<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>position

<span class="token keyword">let</span> x_pi <span class="token operator">=</span> <span class="token number">3.14159265358979324</span> <span class="token operator">*</span> <span class="token number">3000.0</span> <span class="token operator">/</span> <span class="token number">180.0</span>
<span class="token keyword">let</span> x <span class="token operator">=</span> longitude <span class="token operator">-</span> <span class="token number">0.0065</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> latitude <span class="token operator">-</span> <span class="token number">0.006</span>
<span class="token keyword">let</span> z <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.00002</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>y <span class="token operator">*</span> x_pi<span class="token punctuation">)</span>
<span class="token keyword">let</span> wz <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">atan2</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.000003</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>x <span class="token operator">*</span> x_pi<span class="token punctuation">)</span>
<span class="token keyword">let</span> lon <span class="token operator">=</span> z <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>wz<span class="token punctuation">)</span>
<span class="token keyword">let</span> lat <span class="token operator">=</span> z <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>wz<span class="token punctuation">)</span>
longitude <span class="token operator">=</span> lon
latitude <span class="token operator">=</span> lat
uni<span class="token punctuation">.</span><span class="token function">openLocation</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    latitude<span class="token punctuation">,</span>
    longitude<span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> storeName<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/workRecord/vue/" class="prev">
        vue相关
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9047f944.js" defer></script><script src="/assets/js/2.3410de3c.js" defer></script><script src="/assets/js/25.3dc1aead.js" defer></script>
  </body>
</html>
